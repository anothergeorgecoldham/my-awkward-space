---
import Layout from "../layouts/Layout.astro";
import { getAllPosts } from "../utils/getPosts";
import { siteConfig } from "../config/content";

const POSTS_PER_PAGE = 5;
const allPosts = getAllPosts();
const postsData = JSON.stringify(allPosts);
---

<Layout title={`Posts - ${siteConfig.name}`} description="Read my latest posts and notes.">
  <section class="mx-auto w-full max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    <header class="flex items-end justify-between gap-6 mb-8">
      <div>
        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-neutral-900 dark:text-neutral-100">
          Posts
        </h1>
        <p class="mt-3 text-lg leading-7 text-neutral-600 dark:text-neutral-400">
          Notes on security, AI, and the odd practical rabbit-hole.
        </p>
      </div>
    </header>

    <!-- Posts will be injected here -->
    <div id="posts-container" class="flex flex-col gap-6"></div>

    <div id="pagination-container" class="mt-8"></div>
  </section>

  <script define:vars={{ postsData, POSTS_PER_PAGE }}>
    document.addEventListener("DOMContentLoaded", function () {
      const allPosts = JSON.parse(postsData);
      const postsPerPage = POSTS_PER_PAGE;

      const totalPosts = allPosts.length;
      const totalPages = Math.max(1, Math.ceil(totalPosts / postsPerPage));

      const postsContainer = document.getElementById("posts-container");
      const paginationContainer = document.getElementById("pagination-container");
      if (!postsContainer || !paginationContainer) return;

      function getCurrentPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get("page");
        return page ? parseInt(page, 10) : 1;
      }

      function getPageUrl(page) {
        if (page === 1) return "/posts/";
        return `/posts/?page=${page}`;
      }

      function renderPosts(page) {
        const currentPage = Math.max(1, Math.min(page, totalPages));
        const startIndex = (currentPage - 1) * postsPerPage;
        const endIndex = startIndex + postsPerPage;
        const postsToShow = allPosts.slice(startIndex, endIndex);

        postsContainer.innerHTML = postsToShow
          .map(
            (post) => `
              <a href="${post.href}" class="group block">
                <article
                  class="relative rounded-2xl border border-neutral-300 dark:border-neutral-800/70 bg-neutral-100 dark:bg-white/5 p-6
                         transition-all duration-300
                         hover:border-accent-primary/40 hover:bg-accent-primary/10"
                >
                  <div class="flex flex-col gap-3">
                    <h2 class="text-xl sm:text-2xl font-bold tracking-tight text-neutral-900 dark:text-neutral-100 group-hover:text-accent-secondary transition-colors">
                      ${post.title}
                    </h2>

                    <p class="text-neutral-600 dark:text-neutral-400">
